# VK Rent Bot 🏠

Бот для ВКонтакте для размещения и поиска объявлений об аренде квартир. Построен с использованием модульной архитектуры для удобной работы и поддержки.

## 📋 Содержание

- [Возможности](#возможности)
- [Технологии](#технологии)
- [Структура проекта](#структура-проекта)
- [Установка](#установка)
- [Конфигурация](#конфигурация)
- [Запуск](#запуск)
- [Архитектура](#архитектура)
- [Разработка](#разработка)

## ✨ Возможности

### Для пользователей:
- **Размещение объявлений** - пошаговый процесс создания объявления об аренде
- **Поиск объявлений** - фильтрация по району, цене, количеству комнат и дате
- **Предпросмотр** - просмотр и редактирование объявления перед публикацией
- **Загрузка фото** - до 6 фотографий к объявлению
- **Лимиты для неподписчиков** - 3 бесплатных поиска, затем требуется подписка

### Для администраторов:
- Автоматическая публикация в отложенные записи сообщества
- Отслеживание использования поиска
- Гибкая конфигурация через переменные окружения

## 🛠 Технологии

- **Python 3.8+**
- **vkbottle 4.x** - фреймворк для создания VK ботов (FSM, обработчики)
- **python-dotenv** - управление переменными окружения
- **requests** - HTTP запросы к VK API

## 📁 Структура проекта

```
vk-rent-bot/
├── bot/                          # Основной код бота
│   ├── __init__.py              # Инициализация бота
│   ├── config.py                # Конфигурация и env переменные
│   ├── states.py                # Состояния FSM
│   │
│   ├── keyboards/               # Клавиатуры
│   │   ├── __init__.py
│   │   ├── menu.py             # Главное меню
│   │   ├── rent.py             # Клавиатуры для создания объявления
│   │   └── search.py           # Клавиатуры для поиска
│   │
│   ├── handlers/                # Обработчики сообщений
│   │   ├── __init__.py
│   │   ├── menu.py             # Главное меню, /start, поддержка
│   │   ├── rent.py             # Создание объявлений
│   │   └── search.py           # Поиск объявлений
│   │
│   ├── services/                # Бизнес-логика
│   │   ├── __init__.py
│   │   ├── vk_api.py           # Работа с VK API
│   │   ├── post.py             # Публикация постов
│   │   ├── subscription.py     # Проверка подписки
│   │   └── search.py           # Поиск по объявлениям
│   │
│   └── utils/                   # Утилиты
│       ├── __init__.py
│       ├── formatters.py       # Форматирование текста
│       └── validators.py       # Валидация данных
│
├── storage/                     # Хранилище данных
│   ├── __init__.py
│   └── storage.py              # Постоянное хранилище (JSON)
│
├── main.py                      # Точка входа
├── requirements.txt             # Зависимости
├── .env.example                 # Пример конфигурации
├── .gitignore
└── README.md
```

## 🚀 Установка

### 1. Клонирование репозитория

```bash
git clone <url-репозитория>
cd vk-rent-bot
```

### 2. Создание виртуального окружения

```bash
python -m venv venv

# Windows
venv\Scripts\activate

# Linux/Mac
source venv/bin/activate
```

### 3. Установка зависимостей

```bash
pip install -r requirements.txt
```

## ⚙️ Конфигурация

### 1. Создайте файл `.env` на основе `.env.example`:

```bash
cp .env.example .env
```

### 2. Заполните переменные окружения:

```env
# Токены (обязательно один из них)
USER_TOKEN=           # User token администратора (рекомендуется)
GROUP_TOKEN=          # Токен сообщества
UPLOAD_TOKEN=         # Токен для загрузки фото (если отличается)

# Сообщество
GROUP_ID=123456789    # ID вашего сообщества

# API
VK_API_VERSION=5.199  # Версия VK API

# Настройки
SUPPORT_URL=https://vk.com/your_support
MAX_SEARCHES_UNSUBSCRIBED=3    # Лимит поисков для неподписчиков
SEARCH_RESULTS_LIMIT=30        # Максимум результатов поиска

# Хранилище
STORAGE_FILE=bot_storage.json  # Файл для хранения данных
```

### Получение токенов:

#### USER_TOKEN (рекомендуется):
1. Перейдите на [vk.com/apps?act=manage](https://vk.com/apps?act=manage)
2. Создайте Standalone приложение
3. Получите токен с правами: `photos`, `wall`, `groups`, `messages`, `offline`
4. Администратор сообщества должен быть авторизован

#### GROUP_TOKEN:
1. Настройки сообщества → Работа с API → Ключи доступа
2. Создайте ключ с правами: `messages`, `photos`, `wall`

## ▶️ Запуск

```bash
python main.py
```

Бот запустится и начнёт обрабатывать сообщения. Проверьте, что:
- Бот добавлен в сообщество как администратор
- У бота есть права на управление сообщениями
- Long Poll включен в настройках сообщества

## 🏗 Архитектура

### Модульная структура

Проект организован по принципу **разделения ответственности**:

#### 1. **Configuration Layer** (`bot/config.py`)
- Загрузка переменных окружения
- Валидация настроек
- Константы приложения

#### 2. **State Layer** (`bot/states.py`)
- FSM состояния для диалогов
- Промпты для пользователя
- Конфигурация состояний

#### 3. **Presentation Layer** (`bot/keyboards/`)
- Клавиатуры для разных сценариев
- Адаптация UI под контекст
- Переиспользуемые компоненты UI

#### 4. **Handler Layer** (`bot/handlers/`)
- Обработка пользовательского ввода
- Управление состояниями FSM
- Маршрутизация команд

**Handlers:**
- `menu.py` - Главное меню, команды старт, поддержка
- `rent.py` - Процесс создания объявления (9 шагов)
- `search.py` - Поиск с фильтрами и пагинация

#### 5. **Service Layer** (`bot/services/`)
- Бизнес-логика приложения
- Работа с внешними API
- Обработка данных

**Services:**
- `vk_api.py` - Низкоуровневые вызовы VK API
- `post.py` - Загрузка фото и публикация постов
- `subscription.py` - Проверка подписки на сообщество
- `search.py` - Поиск и парсинг объявлений

#### 6. **Utility Layer** (`bot/utils/`)
- Вспомогательные функции
- Форматирование данных
- Валидация ввода

**Utils:**
- `formatters.py` - Форматирование цен, текстов, превью
- `validators.py` - Валидация телефонов, чисел, районов

#### 7. **Storage Layer** (`storage/`)
- Постоянное хранилище данных
- Счётчики использования
- Потокобезопасная работа

### Flow диаграммы

#### Создание объявления:
```
Start → Район → Адрес → Этаж → Комнаты → Цена →
Описание → Фото → ФИО → Телефон → Превью → Отправка
```

#### Поиск объявлений:
```
Start → Район → Цена min → Цена max → Комнаты →
Период → Результаты (с пагинацией)
```

## 👨‍💻 Разработка

### Добавление нового функционала

#### 1. Новое состояние FSM:
```python
# bot/states.py
class RentStates(BaseStateGroup):
    NEW_STATE = "new_state"

STATE_PROMPTS = {
    RentStates.NEW_STATE: "Введите данные:",
}
```

#### 2. Новая клавиатура:
```python
# bot/keyboards/rent.py
def new_keyboard() -> str:
    kb = Keyboard(inline=True)
    kb.add(Text("Кнопка"))
    return kb.get_json()
```

#### 3. Новый handler:
```python
# bot/handlers/rent.py
@bot.on.message(state=RentStates.NEW_STATE)
async def new_state_handler(message: Message):
    # Обработка
    pass
```

#### 4. Новый сервис:
```python
# bot/services/new_service.py
def do_something(param):
    """Описание функции."""
    # Логика
    return result
```

### Тестирование

```bash
# Проверка синтаксиса
python -m py_compile bot/**/*.py

# Запуск с отладкой
python main.py
```

### Логирование

Все логи выводятся в консоль с уровнем INFO. Для изменения уровня:

```python
# bot/config.py
logging.basicConfig(level=logging.DEBUG)
```

## 📝 Лицензия

Проект создан для личного использования.

## 🤝 Поддержка

Если у вас возникли вопросы или предложения:
- Создайте Issue в репозитории
- Свяжитесь с разработчиком

---

**Создано с ❤️ для удобной работы с объявлениями об аренде**
