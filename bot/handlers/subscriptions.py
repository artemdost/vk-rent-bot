"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.
"""
import logging
import json
from vkbottle.bot import Message
from vkbottle import Keyboard, KeyboardButtonColor, Text, Callback

from bot.bot_instance import bot, search_sessions
from bot.keyboards import (
    main_menu_inline,
    subscriptions_list_keyboard,
    subscription_actions_keyboard,
)
from bot.states import SearchStates
from storage import storage

logger = logging.getLogger("subscriptions_handlers")


def format_filters(filters: dict) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é."""
    parts = []

    district = filters.get("district")
    if district:
        parts.append(f"–†–∞–π–æ–Ω: {district}")
    else:
        parts.append("–†–∞–π–æ–Ω: –ª—é–±–æ–π")

    price_min = filters.get("price_min")
    price_max = filters.get("price_max")
    if price_min and price_max:
        parts.append(f"–¶–µ–Ω–∞: {price_min:,} - {price_max:,} ‚ÇΩ".replace(",", " "))
    elif price_min:
        parts.append(f"–¶–µ–Ω–∞: –æ—Ç {price_min:,} ‚ÇΩ".replace(",", " "))
    elif price_max:
        parts.append(f"–¶–µ–Ω–∞: –¥–æ {price_max:,} ‚ÇΩ".replace(",", " "))
    else:
        parts.append("–¶–µ–Ω–∞: –ª—é–±–∞—è")

    rooms = filters.get("rooms")
    if rooms:
        parts.append(f"–ö–æ–º–Ω–∞—Ç: {rooms}")
    else:
        parts.append("–ö–æ–º–Ω–∞—Ç: –ª—é–±–æ–µ")

    return "\n".join(parts)


@bot.on.message(text="üîî –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è")
async def subscribe_to_notifications(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ —Ç–µ–∫—É—â–µ–º—É –ø–æ–∏—Å–∫—É."""
    uid = str(message.from_id)
    user_id = message.from_id

    # –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–∏—Å–∫–∞
    session = search_sessions.get(uid)
    if not session or not session.get("results"):
        await message.answer(
            "‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–∏—Å–∫, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ –µ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.",
            keyboard=main_menu_inline(),
        )
        return

    # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –∏–∑ —Å–µ—Å—Å–∏–∏ (–±–µ–∑ –ø–µ—Ä–∏–æ–¥–∞ - –ø–æ–¥–ø–∏—Å–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞ –≤—Å–µ –Ω–æ–≤—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è)
    filters = {
        "district": session.get("district"),
        "price_min": session.get("price_min"),
        "price_max": session.get("price_max"),
        "rooms": session.get("rooms"),
    }

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã
    existing_subs = storage.get_user_subscriptions(user_id)
    for existing_sub in existing_subs:
        if existing_sub.get("filters") == filters:
            # –°–æ–∑–¥–∞—ë–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –¥—É–±–ª–∏—Ä—É—é—â–µ–π –ø–æ–¥–ø–∏—Å–∫–∏
            kb = Keyboard(inline=True)
            kb.add(Text("–ú–æ–∏ –ø–æ–¥–ø–∏—Å–∫–∏"), color=KeyboardButtonColor.PRIMARY)
            kb.add(Text("–ú–µ–Ω—é"), color=KeyboardButtonColor.SECONDARY)

            await message.answer(
                "‚ö†Ô∏è –£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ —Å —Ç–∞–∫–∏–º–∏ –∂–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏.\n\n"
                "–í—ã –º–æ–∂–µ—Ç–µ —É–ø—Ä–∞–≤–ª—è—Ç—å —Å–≤–æ–∏–º–∏ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É ¬´–ú–æ–∏ –ø–æ–¥–ø–∏—Å–∫–∏¬ª.",
                keyboard=kb.get_json(),
            )
            return

    # –°–æ–∑–¥–∞—ë–º –ø–æ–¥–ø–∏—Å–∫—É
    sub_id = storage.add_subscription(user_id, filters)

    filter_text = format_filters(filters)

    # –°–æ–∑–¥–∞—ë–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –±—ã—Å—Ç—Ä—ã–º –¥–æ—Å—Ç—É–ø–æ–º –∫ –ø–æ–¥–ø–∏—Å–∫–∞–º
    kb = Keyboard(inline=True)
    kb.add(Text("–ú–æ–∏ –ø–æ–¥–ø–∏—Å–∫–∏"), color=KeyboardButtonColor.PRIMARY)
    kb.add(Text("–ú–µ–Ω—é"), color=KeyboardButtonColor.SECONDARY)

    await message.answer(
        f"‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!\n\n"
        f"–í—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏—è—Ö —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:\n\n"
        f"{filter_text}\n\n"
        f"–£–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ–¥–ø–∏—Å–∫–∞–º–∏ –º–æ–∂–Ω–æ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É ¬´–ú–æ–∏ –ø–æ–¥–ø–∏—Å–∫–∏¬ª.",
        keyboard=kb.get_json(),
    )

    logger.info("User %s subscribed with ID %s", user_id, sub_id)


@bot.on.message(text="–ú–æ–∏ –ø–æ–¥–ø–∏—Å–∫–∏")
async def show_subscriptions(message: Message):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ø–æ–¥–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    user_id = message.from_id
    subscriptions = storage.get_user_subscriptions(user_id)

    if not subscriptions:
        await message.answer(
            "üì≠ –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫.\n\n"
            "–ß—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É:\n"
            "1. –ù–∞–∂–º–∏—Ç–µ ¬´–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å¬ª\n"
            "2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞\n"
            "3. –ù–∞–∂–º–∏—Ç–µ ¬´üîî –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è¬ª",
            keyboard=main_menu_inline(),
        )
        return

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ —Å–ø–∏—Å–∫–æ–º –ø–æ–¥–ø–∏—Å–æ–∫
    text = f"üì¨ –í–∞—à–∏ –ø–æ–¥–ø–∏—Å–∫–∏ ({len(subscriptions)}):\n\n"

    for idx, sub in enumerate(subscriptions, 1):
        status = "‚úÖ –ê–∫—Ç–∏–≤–Ω–∞" if sub.get("enabled", True) else "‚è∏ –û—Ç–∫–ª—é—á–µ–Ω–∞"
        filter_text = format_filters(sub.get("filters", {}))

        text += f"{idx}. {status}\n"
        text += f"ID: {sub['id']}\n"
        text += f"{filter_text}\n\n"

    # –°–æ–∑–¥–∞—ë–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–∞–º–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–¥–ø–∏—Å–∫–∏
    kb = Keyboard(inline=True)

    for idx, sub in enumerate(subscriptions, 1):
        is_enabled = sub.get("enabled", True)
        icon = "‚úÖ" if is_enabled else "‚è∏"
        kb.add(Text(f"{icon} –ü–æ–¥–ø–∏—Å–∫–∞ #{idx}"))
        if idx % 2 == 0:
            kb.row()

    if len(subscriptions) % 2 != 0:
        kb.row()

    kb.add(Text("–ú–µ–Ω—é"), color=KeyboardButtonColor.NEGATIVE)

    await message.answer(text, keyboard=kb.get_json())


@bot.on.message(text="‚¨ÖÔ∏è –ö –ø–æ–¥–ø–∏—Å–∫–∞–º")
async def back_to_subscriptions_handler(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ –ø–æ–¥–ø–∏—Å–∫–∞–º."""
    await show_subscriptions(message)


@bot.on.message(text=["‚è∏ –û—Ç–∫–ª—é—á–∏—Ç—å", "‚ñ∂Ô∏è –í–∫–ª—é—á–∏—Ç—å"])
async def toggle_subscription_handler(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏."""
    user_id = message.from_id
    uid = str(user_id)

    from bot.bot_instance import search_sessions
    session = search_sessions.get(uid, {})
    sub_id = session.get("current_subscription_id")

    if not sub_id:
        await message.answer(
            "‚ùå –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –∏–∑ —Å–ø–∏—Å–∫–∞.",
            keyboard=main_menu_inline(),
        )
        return

    new_status = storage.toggle_subscription(user_id, sub_id)
    status_text = "–≤–∫–ª—é—á–µ–Ω–∞" if new_status else "–æ—Ç–∫–ª—é—á–µ–Ω–∞"

    await message.answer(
        f"‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ {status_text}.",
        keyboard=main_menu_inline(),
    )


@bot.on.message(text="üóë –£–¥–∞–ª–∏—Ç—å")
async def delete_subscription_handler(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ (–ø–µ—Ä–≤—ã–π —à–∞–≥ - –∑–∞–ø—Ä–æ—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è)."""
    user_id = message.from_id
    uid = str(user_id)

    from bot.bot_instance import search_sessions
    session = search_sessions.get(uid, {})
    sub_id = session.get("current_subscription_id")

    if not sub_id:
        await message.answer(
            "‚ùå –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –∏–∑ —Å–ø–∏—Å–∫–∞.",
            keyboard=main_menu_inline(),
        )
        return

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    kb = Keyboard(inline=True)
    kb.add(Text("‚úÖ –î–∞, —É–¥–∞–ª–∏—Ç—å"), color=KeyboardButtonColor.NEGATIVE)
    kb.add(Text("‚ùå –û—Ç–º–µ–Ω–∞"), color=KeyboardButtonColor.SECONDARY)

    await message.answer(
        "‚ö†Ô∏è –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É?\n\n"
        "–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.",
        keyboard=kb.get_json(),
    )


@bot.on.message(text="‚úÖ –î–∞, —É–¥–∞–ª–∏—Ç—å")
async def confirm_delete_subscription_handler(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏."""
    user_id = message.from_id
    uid = str(user_id)

    from bot.bot_instance import search_sessions
    session = search_sessions.get(uid, {})
    sub_id = session.get("current_subscription_id")

    if not sub_id:
        await message.answer(
            "‚ùå –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –∏–∑ —Å–ø–∏—Å–∫–∞.",
            keyboard=main_menu_inline(),
        )
        return

    success = storage.delete_subscription(user_id, sub_id)

    if success:
        await message.answer(
            "‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ —É–¥–∞–ª–µ–Ω–∞.",
            keyboard=main_menu_inline(),
        )
        logger.info("User %s deleted subscription %s", user_id, sub_id)
        # –û—á–∏—â–∞–µ–º —Å–µ—Å—Å–∏—é
        if "current_subscription_id" in session:
            del session["current_subscription_id"]
    else:
        await message.answer(
            "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É.",
            keyboard=main_menu_inline(),
        )


@bot.on.message(text="‚ùå –û—Ç–º–µ–Ω–∞")
async def cancel_delete_subscription_handler(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–º–µ–Ω—ã —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏."""
    await message.answer(
        "–£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.",
        keyboard=main_menu_inline(),
    )


def is_subscription_button(message: Message) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–æ–π –≤—ã–±–æ—Ä–∞ –ø–æ–¥–ø–∏—Å–∫–∏."""
    text = (message.text or "").strip()
    return text.startswith("‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ #") or text.startswith("‚è∏ –ü–æ–¥–ø–∏—Å–∫–∞ #")


@bot.on.message(func=is_subscription_button)
async def select_subscription_handler(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ –∏–∑ —Å–ø–∏—Å–∫–∞."""
    text = (message.text or "").strip()
    user_id = message.from_id
    uid = str(user_id)
    subscriptions = storage.get_user_subscriptions(user_id)

    if not subscriptions:
        await message.answer(
            "‚ùå –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.",
            keyboard=main_menu_inline(),
        )
        return

    # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ–º–µ—Ä –ø–æ–¥–ø–∏—Å–∫–∏
    try:
        sub_num = int(text.split("#")[1])
        if sub_num < 1 or sub_num > len(subscriptions):
            raise ValueError()
        sub = subscriptions[sub_num - 1]
    except (ValueError, IndexError):
        await message.answer(
            "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –ø–æ–¥–ø–∏—Å–∫–∏.",
            keyboard=main_menu_inline(),
        )
        return

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –ø–æ–¥–ø–∏—Å–∫–∏ –≤ —Å–µ—Å—Å–∏–∏ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π
    from bot.bot_instance import search_sessions
    if uid not in search_sessions:
        search_sessions[uid] = {}
    search_sessions[uid]["current_subscription_id"] = sub["id"]

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∏ —Å –¥–µ–π—Å—Ç–≤–∏—è–º–∏
    is_enabled = sub.get("enabled", True)
    status = "‚úÖ –ê–∫—Ç–∏–≤–Ω–∞" if is_enabled else "‚è∏ –û—Ç–∫–ª—é—á–µ–Ω–∞"
    filter_text = format_filters(sub.get("filters", {}))

    response_text = (
        f"üìã –ü–æ–¥–ø–∏—Å–∫–∞ #{sub_num}\n"
        f"–°—Ç–∞—Ç—É—Å: {status}\n"
        f"ID: {sub['id']}\n\n"
        f"{filter_text}\n\n"
        f"–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
    )

    # –°–æ–∑–¥–∞—ë–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –¥–µ–π—Å—Ç–≤–∏—è–º–∏
    kb = Keyboard(inline=True)

    if is_enabled:
        kb.add(Text("‚è∏ –û—Ç–∫–ª—é—á–∏—Ç—å"))
    else:
        kb.add(Text("‚ñ∂Ô∏è –í–∫–ª—é—á–∏—Ç—å"), color=KeyboardButtonColor.POSITIVE)

    kb.add(Text("üóë –£–¥–∞–ª–∏—Ç—å"), color=KeyboardButtonColor.NEGATIVE)
    kb.row()
    kb.add(Text("‚¨ÖÔ∏è –ö –ø–æ–¥–ø–∏—Å–∫–∞–º"), color=KeyboardButtonColor.PRIMARY)

    await message.answer(response_text, keyboard=kb.get_json())


